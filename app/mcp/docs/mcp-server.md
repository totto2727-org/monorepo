# MCPサーバー設計書

## 概要

この文書は、統一されたMCP（Model Context Protocol）サーバーの設計について説明します。単一のエンドポイントで複数のドキュメント検索ツールを提供し、統一されたAutoRAGでフィルタリング検索を実現します。

**共通アーキテクチャ**: システム全体の設計については[system-architecture.md](./system-architecture.md)を参照してください。
**データ同期**: Workflowsを使用したデータ同期については[data-sync.md](./data-sync.md)を参照してください。

## アーキテクチャ

### 高レベルコンポーネント

システムは3つの主要コンポーネントで構成されます：

1. **MCPクライアント**: Claude、IDE等のクライアントアプリケーション
2. **Cloudflare Workers**: 統一MCPサーバーの実行環境
3. **統合ドキュメントAutoRAG**: フィルタリング検索機能を提供

統一MCPサーバーは単一エンドポイント`/api/mcp`で全ドキュメントツールを提供し、フィルター機能により対象ドキュメントを絞り込みます。

### コアコンポーネント

#### 1. MCPサーバーコア

- **フレームワーク**: ModelContextProtocol SDK使用
- **トランスポート**: StreamableHTTPTransport
- **プロトコル**: MCP 2024-11-05 仕様準拠
- **設定**: 動的設定による柔軟な構成管理

#### 2. ハンドラーレイヤー

- **ファクトリーパターン**: 型安全なハンドラー作成
- **環境統合**: Cloudflare環境からの動的設定
- **トランスポート管理**: HTTPトランスポートのライフサイクル管理

#### 3. ツール実装

**統一検索アーキテクチャ**:

各ツールは統一されたAutoRAGを使用し、フィルタープロパティで対象ドキュメントを絞り込みます。フィルターはフォルダーキーを使用してドキュメントタイプ（effect、react等）を指定します。

**現在実装済みツール**:

- **search_ai_effect**: Effectライブラリのドキュメント検索

**将来追加予定ツール**:

- **search_ai_react**: Reactドキュメント検索
- **search_ai_vue**: Vueドキュメント検索

**共通機能**:

- 統一Auto RAG使用
- フィルタリング検索
- 検索結果 + AI回答生成
- JSONレスポンス形式
- セキュリティ強化エラーハンドリング

#### 4. 型システム

- 設定管理のための共有型定義
- 全コンポーネントでのTypeScript型安全性

## 実装ファイル

### ファイル構成

プロジェクト内の主要ファイル：

- **entry.hono.ts**: Honoアプリケーションエントリーポイント
- **entry.worker.ts**: Workersエントリーポイント
- **hono.ts**: Honoファクトリー設定
- **mcp/server.ts**: MCPサーバーとツール実装
- **mcp/handler.ts**: MCPハンドラーファクトリー
- **mcp/types.ts**: 共有型定義

### リファクタリングによる主な改善点

1. **関心の分離**: MCPサーバーロジックとHTTP処理の明確な分離
2. **依存性注入**: 設定関数による環境依存の外部化
3. **型安全性**: 共有型定義による一貫性確保
4. **拡張性**: ファクトリーパターンによる他ドキュメントソースへの容易な拡張
5. **セキュリティ**: サーバーサイドログとサニタイズされたクライアントレスポンスによる強化されたエラーハンドリング

## 設定

### 環境変数とバインディング

Cloudflare Workersバインディングによる設定管理：

- **AIバインディング**: Cloudflare AIサービスアクセス
- **R2バケット**: 統一ドキュメントストレージ
- **Auto RAG**: 統一Auto RAG設定

設定ファイル: wrangler.jsonc

### 依存関係

依存関係はPNPMカタログモードで管理されています。

主要な依存関係：

- Hono用MCP統合
- 公式MCP SDK
- Webフレームワーク
- スキーマバリデーション

## セキュリティとパフォーマンス

### セキュリティ強化

- **入力パラメータバリデーション**: 全入力に対するスキーマバリデーション
- **エラー情報保護**: 詳細エラーはサーバーサイドのみでログ出力
- **サニタイズされたクライアントレスポンス**: 汎用エラーメッセージで情報漏洩を防止
- **統一バインディング**: マルチドキュメント対応のための統一された命名規則

### パフォーマンス考慮事項

- **適切なタイムアウト設定**: Cloudflare Workers経由で設定可能
- **エラーハンドリングとリトライロジック**: 堅牢なエラー復旧機構
- **ファクトリーパターンの効率性**: 最小限のオーバーヘッドでの再利用可能なハンドラー作成

## エラーハンドリング

### セキュリティファーストアプローチ

- **サーバーサイドログ**: 詳細エラー情報のログ出力
- **クライアントレスポンスサニタイゼーション**: 汎用エラーメッセージのみ
- **情報漏洩防止**: 機密性のあるサーバー詳細をクライアントに公開しない

## アーキテクチャの利点

### 運用の簡素化

- **単一エンドポイント**: `/api/mcp`でクライアント設定が簡潔
- **マルチドキュメント対応**: 統一されたアーキテクチャで複数ドキュメントを効率的に管理

### 拡張性

- **新ドキュメントソース追加**: 型定義とデータソース設定で新しい検索ツールを追加
- **統一設定**: 単一のAutoRAGとR2バケットで複数ドキュメント管理
- **フィルタリング**: 各ツールが対象フォルダのみを検索

### 保守性向上

- **統一アーキテクチャ**: マルチドキュメント対応の一貫した設計
- **設定駆動**: コード変更を最小限に抑えた機能追加
- **型安全性**: TypeScriptによる型管理

## 使用例

### 利用可能なツール

- **search_ai_effect**: Effect関連の検索
  - Effect Data型の使い方
  - Effect.genでのエラーハンドリング
  - Effectのパイプライン処理

### 期待される応答

各ツールは対象ライブラリの公式ドキュメントを検索し、使用パターンとベストプラクティスについて詳細で実用的なAI回答を生成します。フィルタリング機能により、関連性の高い情報のみを検索対象とします。

## 監視と可観測性

- **Cloudflare Workers Analytics**: 組み込みパフォーマンス監視
- **Effectドキュメント検索分析**: クエリパターン分析
- **Auto RAG使用量監視**: リソース使用率追跡
- **エラーログとパフォーマンス追跡**: Cloudflareプラットフォームによる包括的な可観測性

## データ同期との統合

MCPサーバーはWorkflowsによって定期的に更新される統一R2データを参照します：

- **データソース**: 統一R2バケット
- **更新頻度**: 週次（Workflowsにより自動更新）
- **フォルダ構造**: ドキュメントタイプ別分類保存
- **フィルタリング**: AutoRAGの自動メタデータを使用したフォルダベース検索
- **データ形式**: テキスト形式（将来的にMarkdownも対応予定）

詳細については[data-sync.md](./data-sync.md)を参照してください。
