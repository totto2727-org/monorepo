# MCPサーバー設計書

## 概要

この文書は、EffectドキュメントのMCP（Model Context Protocol）サーバーの設計について説明します。単一のエンドポイントでEffectドキュメント検索ツールを提供します。

**共通アーキテクチャ**: システム全体の設計については[architecture.md](./architecture.md)を参照してください。
**データ同期**: Workflowsを使用したデータ同期については[data-sync.md](./data-sync.md)を参照してください。

## アーキテクチャ

### 高レベルコンポーネント

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MCP Client    │────│  Cloudflare     │────│  Effect Docs    │
│   (Claude/IDEs) │    │   Workers       │    │   Auto RAG      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                    │                        │
         │              ┌─────┴─────┐                  │
         └──/api/mcp────│  Effect   │──────────────────┘
                        │MCP Server │
                        └─────┬─────┘
                              │
                        Single Tool:
                        • search_ai_effect
```

### コアコンポーネント

#### 1. MCPサーバーコア

- **フレームワーク**: `@modelcontextprotocol/sdk`
- **トランスポート**: `StreamableHTTPTransport`
- **プロトコル**: MCP 2024-11-05 仕様準拠
- **設定**: `McpServerConfig`による動的設定
- **実装**: [app/mcp/server.ts](./app/mcp/server.ts)

#### 2. ハンドラーレイヤー

- **ファクトリーパターン**: Hono Factory Helperによる型安全なハンドラー作成
- **環境統合**: Cloudflare.Envからの動的設定
- **トランスポート管理**: HTTPトランスポートのライフサイクル管理
- **実装**: [app/mcp/handler.ts](./app/mcp/handler.ts)

#### 3. ツール実装

**ツール名**: `search_ai_effect`

- **search_ai_effect**: Effectライブラリのドキュメント検索

**共通機能**:

- Auto RAG統合
- 検索結果 + AI回答生成
- JSONレスポンス形式
- **セキュリティ**: エラー詳細をクライアントレスポンスから除外

#### 4. 型システム

- 設定管理のための共有型定義
- 全コンポーネントでのTypeScript型安全性
- **実装**: [app/mcp/types.ts](./app/mcp/types.ts)

## 実装ファイル

### ファイル構成

```
app/
├── entry.hono.ts           # Honoアプリケーションエントリーポイント
├── entry.worker.ts         # Workersエントリーポイント
├── hono.ts                 # Honoファクトリー設定
└── mcp/
    ├── server.ts           # MCPサーバーとツール実装
    ├── handler.ts          # MCPハンドラーファクトリー
    └── types.ts            # 共有型定義
```

### リファクタリングによる主な改善点

1. **関心の分離**: MCPサーバーロジックとHTTP処理の明確な分離
2. **依存性注入**: 設定関数による環境依存の外部化
3. **型安全性**: 共有型定義による一貫性確保
4. **拡張性**: ファクトリーパターンによる他ドキュメントソースへの容易な拡張
5. **セキュリティ**: サーバーサイドログとサニタイズされたクライアントレスポンスによる強化されたエラーハンドリング

## 設定

### 環境変数とバインディング

Cloudflare Workersバインディングによる設定管理:

- **AIバインディング**: `AI` - Cloudflare AIサービスアクセス
- **R2バケット**: `EFFECT_DATA_SOURCE` - Effectドキュメントストレージ
- **Auto RAG**: `EFFECT_AUTO_RAG_NAME` - Effect専用Auto RAG設定

**設定ファイル**: [wrangler.jsonc](./wrangler.jsonc)

### 依存関係

依存関係は[package.json](./package.json)で定義されたPNPMカタログモードで管理されています。

主要な依存関係:

- `@hono/mcp` - Hono用MCP統合
- `@modelcontextprotocol/sdk` - 公式MCP SDK
- `hono` - Webフレームワーク
- `zod` - スキーマバリデーション

## セキュリティとパフォーマンス

### セキュリティ強化

- **入力パラメータバリデーション**: 全入力に対するZodスキーマバリデーション
- **エラー情報保護**: 詳細エラーはサーバーサイドのみでログ出力
- **サニタイズされたクライアントレスポンス**: 汎用エラーメッセージで情報漏洩を防止
- **環境固有バインディング**: マルチドキュメント対応のための明確な命名規則（`EFFECT_*`）

### パフォーマンス考慮事項

- **適切なタイムアウト設定**: Cloudflare Workers経由で設定可能
- **エラーハンドリングとリトライロジック**: 堅牢なエラー復旧機構
- **ファクトリーパターンの効率性**: 最小限のオーバーヘッドでの再利用可能なハンドラー作成

## エラーハンドリング

### セキュリティファーストアプローチ

- **サーバーサイドログ**: `console.error()`による詳細エラー情報のログ出力
- **クライアントレスポンスサニタイゼーション**: 汎用エラーメッセージのみ
- **情報漏洩防止**: 機密性のあるサーバー詳細をクライアントに公開しない

## アーキテクチャの利点

### 運用の簡素化

- **単一エンドポイント**: `/api/mcp`でクライアント設定が簡潔
- **Effect専用設計**: Effectドキュメントに特化した効率的な実装

### 拡張性

- **新ドキュメントソース追加**: 設定変更のみで新しい検索ツールを追加
- **環境別設定**: プレフィックスベースのバインディング管理
  - Effect: `EFFECT_AUTO_RAG_NAME`、`EFFECT_DATA_SOURCE`

### 保守性向上

- **シンプルな構造**: 単一ドキュメントソースに特化した設計
- **設定駆動**: コード変更を最小限に抑えた機能追加
- **型安全性**: TypeScriptによる型管理

## 使用例

### 利用可能なツール

- **search_ai_effect**: Effect関連の検索
  - "Effect Data型の使い方"
  - "Effect.genでのエラーハンドリング"
  - "Effectのパイプライン処理"

### 期待される応答

ツールはEffectライブラリの公式ドキュメントを検索し、使用パターンとベストプラクティスについて詳細で実用的なAI回答を生成します。

## 監視と可観測性

- **Cloudflare Workers Analytics**: 組み込みパフォーマンス監視
- **Effectドキュメント検索分析**: クエリパターン分析
- **Auto RAG使用量監視**: リソース使用率追跡
- **エラーログとパフォーマンス追跡**: Cloudflareプラットフォームによる包括的な可観測性

## データ同期との統合

MCPサーバーはWorkflowsによって定期的に更新されるR2データを参照します：

- **データソース**: R2バケット（`EFFECT_DATA_SOURCE`）
- **更新頻度**: 週次（Workflowsにより自動更新）
- **データ形式**: テキスト形式（将来的にMarkdownも対応予定）

詳細については[data-sync.md](./data-sync.md)を参照してください。
