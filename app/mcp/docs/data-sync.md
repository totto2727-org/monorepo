# データ同期システム設計書

## 概要

この文書は、MCPサーバー用のデータソース定期更新システムの設計について説明します。

**共通アーキテクチャ**: システム全体の設計については[architecture.md](./architecture.md)を参照してください。

## アーキテクチャ

### 高レベルコンポーネント

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Scheduled     │────│  Data Sources   │────│   R2 Storage    │
│   Worker        │    │  (HTTP/Firecrawl)│    │   (Raw Data)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                                              │
         │              ┌─────────────────┐             │
         └──────────────│  Auto RAG       │─────────────┘
                        │  Processing     │
                        └─────────────────┘
```

### コアコンポーネント

#### 1. Scheduled Worker

- **フレームワーク**: Cloudflare Workers + Scheduled Events
- **実行頻度**: 週次（固定）
- **責務**: データソースの監視と更新トリガー
- **設定**: `DataSourceConfig`による動的設定

#### 2. データソースハンドラー

**HTTPデータソース**

- 単純なHTTP GETリクエスト
- 取得したテキストをそのまま保存

**Firecrawlデータソース**

- Firecrawl APIを使用したWebスクレイピング
- Markdown形式での構造化コンテンツ抽出

#### 3. データストレージ

- **プライマリ**: R2バケット
- **データ形式**:
  - Firecrawl: Markdown形式
  - HTTP: 取得テキストそのまま
- **更新方式**: 既存データの上書き更新

## 型定義

### データソース設定

データソース設定の型定義は[app/sync/types.ts](./app/sync/types.ts)で管理されています。

### 新規型定義要件

- データ取得結果の構造化
- 同期ジョブの実行結果管理
- エラーハンドリング用の型定義

## ファイル構成

### 新規追加予定

```
app/
├── sync/
│   ├── data-sync.ts        # メインscheduled worker
│   ├── data-fetcher.ts     # データ取得ロジック
│   ├── r2-storage.ts       # R2操作ユーティリティ
│   └── error-handler.ts    # エラーハンドリング
└── mcp/
    └── types.ts            # 共通型定義（既存 + 追加）
```

## 設定管理

### 環境変数による設定

- データソース配列の動的設定
- R2バケット指定
- 週次実行スケジュール

### 設定例構造

- HTTP APIエンドポイント設定
- Firecrawl対象URL設定
- 週次実行タイミング（固定）

## Auto RAGとの統合

### データフロー

1. 週次Scheduled Workerによるデータ収集
2. R2への形式別データ保存（Markdown/テキスト）
3. Auto RAGによる自動インデックス化
4. MCPツールからの検索可能化

### データ形式の統一

- Auto RAG互換フォーマットでの保存
- 検索効率を考慮したデータ構造

この設計により、効率的で拡張可能なデータ同期システムを構築し、MCPサーバーのデータ品質と最新性を確保します。
